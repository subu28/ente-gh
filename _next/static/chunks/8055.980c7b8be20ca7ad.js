(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8055],{22216:function(t,e,r){"use strict";var i,o,a,n,s,c;r.d(e,{_:function(){return l}});let l="Hidden";(n=i||(i={})).folder="folder",n.favorites="favorites",n.album="album",n.uncategorized="uncategorized",(s=o||(o={})).folder="folder",s.favorites="favorites",s.album="album",s.archive="archive",s.trash="trash",s.uncategorized="uncategorized",s.all="all",s.outgoingShare="outgoingShare",s.incomingShareViewer="incomingShareViewer",s.incomingShareCollaborator="incomingShareCollaborator",s.sharedOnlyViaLink="sharedOnlyViaLink",s.archived="archived",s.defaultHidden="defaultHidden",s.hiddenItems="hiddenItems",s.pinned="pinned",(c=a||(a={}))[c.NAME=0]="NAME",c[c.CREATION_TIME_ASCENDING=1]="CREATION_TIME_ASCENDING",c[c.UPDATION_TIME_DESCENDING=2]="UPDATION_TIME_DESCENDING"},6114:function(t,e,r){"use strict";var i,o,a,n;(a=i||(i={}))[a.START=0]="START",a[a.READING_GOOGLE_METADATA_FILES=1]="READING_GOOGLE_METADATA_FILES",a[a.EXTRACTING_METADATA=2]="EXTRACTING_METADATA",a[a.UPLOADING=3]="UPLOADING",a[a.CANCELLING=4]="CANCELLING",a[a.FINISH=5]="FINISH",(n=o||(o={}))[n.FAILED=0]="FAILED",n[n.ALREADY_UPLOADED=1]="ALREADY_UPLOADED",n[n.UNSUPPORTED=2]="UNSUPPORTED",n[n.BLOCKED=3]="BLOCKED",n[n.TOO_LARGE=4]="TOO_LARGE",n[n.LARGER_THAN_AVAILABLE_STORAGE=5]="LARGER_THAN_AVAILABLE_STORAGE",n[n.UPLOADED=6]="UPLOADED",n[n.UPLOADED_WITH_STATIC_THUMBNAIL=7]="UPLOADED_WITH_STATIC_THUMBNAIL",n[n.ADDED_SYMLINK=8]="ADDED_SYMLINK"},5155:function(t,e,r){"use strict";r.d(e,{Iz:function(){return s},kp:function(){return c},zr:function(){return n}});var i=r(95525),o=r(89610);r(10005),r(96045),r(88659),r(18786),r(73873),r(94522),r(35042),r(22216),r(24991),r(40795);var a=r(16414);r(79541),r(71583),r(82797),r(59372),(0,i.O3)();let n=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"normal",e=await s();return"normal"===t?(0,a.bA)(e):(0,a.D0)(e)},s=async()=>{var t;return null!==(t=await o.Z.getItem("collections"))&&void 0!==t?t:[]},c=(t,e)=>{let r=new Set;for(let t of e)r.add(t.collectionID);return t.filter(t=>r.has(t.id))}},55151:function(t,e,r){"use strict";r.d(e,{S:function(){return c}});var i=r(58178),o=r(54032),a=r(18786),n=r(5025),s=r.n(n);let c=async t=>l(()=>d(t),t.name),l=async(t,e)=>{try{let e;let r=await u(await t()),o=r.mime;if(o.startsWith("image/"))e=i.Gk.IMAGE;else if(o.startsWith("video/"))e=i.Gk.VIDEO;else throw Error(a.sH.UNSUPPORTED_FILE_FORMAT);return{fileType:e,extension:r.ext,mimeType:o}}catch(n){let t=(0,o.qN)(e),r=i.kz.find(e=>e.extension==t);if(r)return r;if(i.vD.includes(t))throw Error(a.sH.UNSUPPORTED_FILE_FORMAT);throw n}},d=async t=>{let e=t.slice(0,4100);return new Uint8Array(await e.arrayBuffer())},u=async t=>{let e=await s().fromBuffer(t);if(!e)throw Error("Could not deduce file type from the file's contents");return e}},47371:function(t,e,r){"use strict";r.d(e,{Z:function(){return P}});var i=r(58178),o=r(42917),a=r(57532),n=r(96045),s=r(88659),c=r(18786);async function l(t){return await new Promise(e=>{let r=setTimeout(()=>{e(!1)},1e3),i=document.createElement("video");i.addEventListener("canplay",function(){clearTimeout(r),i.remove(),i.duration>0?e(!0):e(!1)}),i.addEventListener("error",function(){clearTimeout(r),i.remove(),e(!1)}),i.src=t})}var d=r(72751),u=r.n(d),f=r(25869),h=r(79541),E=r(73873),p=r(95525),w=r(86345);class m{updateTokens(t){this.token=t}async downloadThumbnail(t){let e=this.token;if(!e)throw Error(c.sH.TOKEN_MISSING);let r=await (0,w.S0)(()=>{let r={responseType:"arraybuffer",timeout:this.timeout},i=(0,p.dd)();if(!i)return E.Z.get("https://thumbnails.ente.io/?fileID=".concat(t.id),void 0,{"X-Auth-Token":e},r);{let o=new URLSearchParams({token:e});return E.Z.get("".concat(i,"/files/preview/").concat(t.id,"?").concat(o.toString()),void 0,void 0,r)}});if(void 0===r.data)throw Error(c.sH.REQUEST_FAILED);return new Uint8Array(r.data)}async downloadFile(t,e){let r=this.token;if(!r)throw Error(c.sH.TOKEN_MISSING);let i=await (0,w.S0)(()=>{let i={responseType:"arraybuffer",timeout:this.timeout,onDownloadProgress:e},o=(0,p.dd)();if(!o)return E.Z.get("https://files.ente.io/?fileID=".concat(t.id),void 0,{"X-Auth-Token":r},i);{let e=new URLSearchParams({token:r});return E.Z.get("".concat(o,"/files/download/").concat(t.id,"?").concat(e.toString()),void 0,void 0,i)}});if(void 0===i.data)throw Error(c.sH.REQUEST_FAILED);return new Uint8Array(i.data)}async downloadFileStream(t){let e=this.token;if(!e)throw Error(c.sH.TOKEN_MISSING);return(0,w.S0)(()=>{let r=(0,p.dd)();if(!r)return fetch("https://files.ente.io/?fileID=".concat(t.id),{headers:{"X-Auth-Token":e}});{let i=new URLSearchParams({token:e});return fetch("".concat(r,"/files/download/").concat(t.id,"?").concat(i.toString()))}})}constructor(t,e){this.token=t,this.timeout=e}}class g{updateTokens(t,e){this.token=t,this.passwordToken=e}async downloadFileStream(t){let e=this.token,r=this.passwordToken;if(!e)throw Error(c.sH.TOKEN_MISSING);return(0,w.S0)(()=>{let i=(0,p.dd)();if(!i)return fetch("https://public-albums.ente.io/download/?fileID=".concat(t.id),{headers:{"X-Auth-Access-Token":e,...r&&{"X-Auth-Access-Token-JWT":r}}});{let o=new URLSearchParams({accessToken:e,...r&&{accessTokenJWT:r}});return fetch("".concat(i,"/public-collection/files/download/").concat(t.id,"?").concat(o.toString()))}})}constructor(t){this.timeout=t,this.downloadThumbnail=async t=>{let e=this.token,r=this.passwordToken;if(!e)throw Error(c.sH.TOKEN_MISSING);let i=await (()=>{let i={responseType:"arraybuffer"},o=(0,p.dd)();if(!o)return E.Z.get("https://public-albums.ente.io/preview/?fileID=".concat(t.id),void 0,{"X-Auth-Access-Token":e,...r&&{"X-Auth-Access-Token-JWT":r}},i);{let a=new URLSearchParams({accessToken:e,...r&&{accessTokenJWT:r}});return E.Z.get("".concat(o,"/public-collection/files/preview/").concat(t.id,"?").concat(a.toString()),void 0,void 0,i)}})();if(void 0===i.data)throw Error(c.sH.REQUEST_FAILED);return new Uint8Array(i.data)},this.downloadFile=async(t,e)=>{let r=this.token,i=this.passwordToken;if(!r)throw Error(c.sH.TOKEN_MISSING);let o=await (0,w.S0)(()=>{let o={responseType:"arraybuffer",timeout:this.timeout,onDownloadProgress:e},a=(0,p.dd)();if(!a)return E.Z.get("https://public-albums.ente.io/download/?fileID=".concat(t.id),void 0,{"X-Auth-Access-Token":r,...i&&{"X-Auth-Access-Token-JWT":i}},o);{let e=new URLSearchParams({accessToken:r,...i&&{accessTokenJWT:i}});return E.Z.get("".concat(a,"/public-collection/files/download/").concat(t.id,"?").concat(e.toString()),void 0,void 0,o)}});if(void 0===o.data)throw Error(c.sH.REQUEST_FAILED);return new Uint8Array(o.data)}}}class T{async init(t){if(this.ready){n.ZP.info("DownloadManager already initialized");return}this.downloadClient=O(t);try{this.thumbnailCache=await (0,a.Pr)("thumbs")}catch(t){n.ZP.error("Failed to open thumbnail cache, will continue without it",t)}this.cryptoWorker=await s.Z.getInstance(),this.ready=!0}ensureInitialized(){if(!this.ready)throw Error("Attempting to use an uninitialized download manager")}async logout(){this.ready=!1,this.cryptoWorker=null,this.downloadClient=null,this.fileObjectURLPromises.clear(),this.fileConversionPromises.clear(),this.thumbnailObjectURLPromises.clear(),this.fileDownloadProgress.clear(),this.progressUpdater=()=>{}}updateToken(t,e){this.downloadClient.updateTokens(t,e)}updateCryptoWorker(t){this.cryptoWorker=t}setProgressUpdater(t){this.progressUpdater=t}async getThumbnail(t){var e,r;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.ensureInitialized();let o=t.id.toString(),a=await (null===(e=this.thumbnailCache)||void 0===e?void 0:e.get(o));if(a)return new Uint8Array(await a.arrayBuffer());if(i)return null;let n=await this.downloadThumb(t);return null===(r=this.thumbnailCache)||void 0===r||r.put(o,new Blob([n])),n}async getThumbnailForPreview(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.ensureInitialized();try{if(!this.thumbnailObjectURLPromises.has(t.id)){let r=this.getThumbnail(t,e).then(t=>t&&URL.createObjectURL(new Blob([t])));this.thumbnailObjectURLPromises.set(t.id,r)}let r=await this.thumbnailObjectURLPromises.get(t.id);return r||e||(this.thumbnailObjectURLPromises.delete(t.id),r=await this.getThumbnailForPreview(t,e)),r}catch(e){throw this.thumbnailObjectURLPromises.delete(t.id),n.ZP.error("get DownloadManager preview Failed",e),e}}async getFile(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.ensureInitialized();try{let r=async()=>{let e=await this.downloadFile(t),r=await new Response(e).blob();return{url:URL.createObjectURL(r),isOriginal:!0,isRenderable:!1,type:"normal"}};if(!this.fileObjectURLPromises.has(t.id)){if(!e)return await this.downloadFile(t);this.fileObjectURLPromises.set(t.id,r())}let i=await this.fileObjectURLPromises.get(t.id);if(i.isOriginal)return(await fetch(i.url)).body;return await this.downloadFile(t)}catch(e){throw this.fileObjectURLPromises.delete(t.id),n.ZP.error("download manager getFile Failed",e),e}}async downloadFile(t){var e,r,o,a,s;let l;n.ZP.info("download attempted for file id ".concat(t.id));let d=this.trackDownloadProgress(t.id,null===(e=t.info)||void 0===e?void 0:e.fileSize),u=t.id.toString();if(t.metadata.fileType===i.Gk.IMAGE||t.metadata.fileType===i.Gk.LIVE_PHOTO){let e=await (null===(o=this.fileCache)||void 0===o?void 0:o.get(u)),r=await (null==e?void 0:e.arrayBuffer());r||(r=(await this.downloadClient.downloadFile(t,d)).buffer,null===(a=this.fileCache)||void 0===a||a.put(u,new Blob([r]))),this.clearDownloadProgress(t.id);try{let e=await this.cryptoWorker.decryptFile(new Uint8Array(r),await this.cryptoWorker.fromB64(t.file.decryptionHeader),t.key);return new Response(e).body}catch(e){throw e.message===c.sH.PROCESSING_FAILED&&n.ZP.error("Failed to process file with fileID:".concat(t.id,", localID: ").concat(t.metadata.localID,", version: ").concat(t.metadata.version,", deviceFolder:").concat(t.metadata.deviceFolder),e),e}}let f=await (null===(r=this.fileCache)||void 0===r?void 0:r.get(u)),h=(l=f?new Response(f):await this.downloadClient.downloadFileStream(t)).body.getReader(),E=+l.headers.get("Content-Length"),p=0,w=await this.cryptoWorker.fromB64(t.file.decryptionHeader),m=await this.cryptoWorker.fromB64(t.key),{pullState:g,decryptionChunkSize:T}=await this.cryptoWorker.initChunkDecryption(w,m),P=new Uint8Array;return new ReadableStream({pull:async t=>{let e=!1;do{let r;let{done:i,value:o}=await h.read();for(i?r=P:(d({loaded:p+=o.length,total:E}),(r=new Uint8Array(P.length+o.length)).set(new Uint8Array(P),0),r.set(new Uint8Array(o),P.length));r.length>=T;){let{decryptedData:i}=await this.cryptoWorker.decryptFileChunk(r.slice(0,T),g);t.enqueue(i),e=!0,r=r.slice(T)}if(i){if(r.length){let{decryptedData:e}=await this.cryptoWorker.decryptFileChunk(r,g);t.enqueue(e)}e=!0,t.close()}else P=r}while(!e)}})}constructor(){var t=this;this.ready=!1,this.fileObjectURLPromises=new Map,this.fileConversionPromises=new Map,this.thumbnailObjectURLPromises=new Map,this.fileDownloadProgress=new Map,this.progressUpdater=()=>{},this.downloadThumb=async t=>{let e=await this.downloadClient.downloadThumbnail(t);return await this.cryptoWorker.decryptThumbnail(e,await this.cryptoWorker.fromB64(t.thumbnail.decryptionHeader),t.key)},this.getFileForPreview=async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t.ensureInitialized();try{let i=async()=>{let i=await new Response(await t.getFile(e,!0)).blob(),{url:o}=await t.fileObjectURLPromises.get(e.id);return await y(e,i,o,r)};return(r||!t.fileConversionPromises.has(e.id))&&t.fileConversionPromises.set(e.id,i()),await t.fileConversionPromises.get(e.id)}catch(r){throw t.fileConversionPromises.delete(e.id),n.ZP.error("download manager getFileForPreview Failed",r),r}},this.trackDownloadProgress=(t,e)=>r=>{if(isNaN(r.total)||0===r.total){if(!e)return;r.total=e}r.loaded===r.total?this.fileDownloadProgress.delete(t):this.fileDownloadProgress.set(t,Math.round(100*r.loaded/r.total)),this.progressUpdater(new Map(this.fileDownloadProgress))},this.clearDownloadProgress=t=>{this.fileDownloadProgress.delete(t),this.progressUpdater(new Map(this.fileDownloadProgress))}}}var P=new T;let O=t=>t?new m(t,3e5):new g(3e5);async function y(t,e,r,o){let a,n,s,c;let l=t=>t?t===e?r:URL.createObjectURL(t):void 0,d="normal";switch(t.metadata.fileType){case i.Gk.IMAGE:{let i=await (0,h.Qq)(t.metadata.title,e),o=l(i);a=o,n=o===r,s=!!o,c=null==i?void 0:i.type;break}case i.Gk.LIVE_PHOTO:a=await R(t,e,o),n=!1,s=!1,d="livePhoto";break;case i.Gk.VIDEO:{let i=await x(t.metadata.title,e,o),d=l(i);a=d,n=d===r,s=!!d,c=null==i?void 0:i.type;break}default:a=r,n=!0,s=!1}return{url:a,isOriginal:n,isRenderable:s,type:d,mimeType:c}}async function R(t,e,r){let i=await (0,o.tc)(t.metadata.title,e);return{image:async()=>{try{let t=new Blob([i.imageData]),e=await (0,h.Qq)(i.imageFileName,t);return URL.createObjectURL(e)}catch(t){return null}},video:async()=>{try{let t=new Blob([i.videoData]),e=await x(i.videoFileName,t,r,!0);return URL.createObjectURL(e)}catch(t){return null}}}}async function x(t,e){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];try{if(await l(URL.createObjectURL(e))&&!r)return e;{if(!r&&!i&&!u()())return null;n.ZP.info("Converting video ".concat(t," to mp4"));let o=await f.An(e);return new Blob([o],{type:"video/mp4"})}}catch(t){return n.ZP.error("Video conversion failed",t),null}}},33009:function(t,e,r){"use strict";r.d(e,{Qh:function(){return n}});var i=r(96045);r(6114),r(58456);var o=r(25823),a=r.n(o);async function n(t,e,r){try{let i=await s(t,e);i="data:image/jpeg;base64"+i.slice(i.indexOf(","));let o=a().load(i);o.Exif||(o.Exif={}),o.Exif[a().ExifIFD.DateTimeOriginal]="".concat(r.getFullYear(),":").concat(r.getMonth()+1,":").concat(r.getDate()," ").concat(r.getHours(),":").concat(r.getMinutes(),":").concat(r.getSeconds());let n=a().dump(o),c=a().insert(n,i);return function(t){let e=atob(t.split(",")[1]),r=t.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(e.length),o=new Uint8Array(i);for(let t=0;t<e.length;t++)o[t]=e.charCodeAt(t);return new Blob([i],{type:r})}(c)}catch(t){return i.ZP.error("updateFileModifyDateInEXIF failed",t),e}}async function s(t,e){return await new Promise(r=>{t.onload=()=>r(t.result),t.readAsDataURL(e)})}},32522:function(t,e,r){"use strict";r.d(e,{ZP:function(){return W},ob:function(){return G},Ie:function(){return j},fv:function(){return Y},HE:function(){return J},CO:function(){return ta},fe:function(){return ti}});var i,o,a=r(58178),n=r(42917),s=r(82155),c=r(96045),l=r(11200),d=r(18786),u=r(44439),f=r(10005),h=r(62594),E=r(7174),p=r(16414),w=r(79541),m=r(63490),g=r(10277),T=r(5155),P=r(47371),O=r(82797),y=r(54032);async function R(t,e,r){try{c.ZP.info("current export version: ".concat(e.version)),0===e.version&&(c.ZP.info("migrating export to version 1"),await x(t,e),e=await W.updateExportRecord(t,{version:1}),c.ZP.info("migration to version 1 complete")),1===e.version&&(c.ZP.info("migrating export to version 2"),await v(e,t),e=await W.updateExportRecord(t,{version:2}),c.ZP.info("migration to version 2 complete")),2===e.version&&(c.ZP.info("migrating export to version 3"),await I(t,e,r),e=await W.updateExportRecord(t,{version:3}),c.ZP.info("migration to version 3 complete")),3===e.version&&(c.ZP.info("migrating export to version 4"),await S(t,e),e=await W.updateExportRecord(t,{version:4}),c.ZP.info("migration to version 4 complete")),4===e.version&&(c.ZP.info("migrating export to version 5"),await _(t,e),e=await W.updateExportRecord(t,{version:5}),c.ZP.info("migration to version 5 complete")),c.ZP.info("Record at latest version")}catch(t){throw c.ZP.error("export record migration failed",t),t}}async function x(t,e){if(!(null==e?void 0:e.exportedFiles))return;let r=new Map,i=(0,f.Yu)(f.Pd.USER),o=(0,w.SA)(await (0,O.NJ)()),a=await (0,T.zr)(),n=(0,w.DJ)((0,w.$9)(o,i)),s=(0,p.R5)(a,n,i);await D(s,t,r),await N(k(n,e),r)}async function v(t,e){await A(t,e)}async function I(t,e,r){if(!(null==e?void 0:e.exportedFiles))return;let i=(0,f.Yu)(f.Pd.USER),o=(0,w.SA)(await (0,O.NJ)()),a=(0,w.DJ)((0,w.$9)(o,i)),n=await L(e),s=await b(e,k(a,e),r);e.exportedCollectionPaths=void 0,e.exportedFiles=void 0;let c={...e,fileExportNames:s,collectionExportNames:n};await W.updateExportRecord(t,c)}async function S(t,e){if(!(null==e?void 0:e.collectionExportNames))return;let r=Object.fromEntries(Object.entries(e.collectionExportNames).map(t=>{let[e,r]=t;return[e,r.split("/").pop()]})),i={...e,collectionExportNames:r};await W.updateExportRecord(t,i)}async function _(t,e){await U(t,e)}let D=async(t,e,r)=>{let i=(0,s.M)().fs;for(let o of t){let t="".concat(e,"/").concat(o.id,"_").concat(H(o.name)),a=await (0,m.MC)(e,o.name,i.exists);r.set(o.id,a),await i.exists(t)&&(await i.rename(t,a),await F(e,o.id,a))}};async function N(t,e){let r=(0,s.M)().fs;for(let i of t){let t=e.get(i.collectionID),o="".concat(t,"/").concat(G),a="".concat(i.id,"_").concat(H(i.metadata.title)),n="".concat(t,"/").concat(a),s="".concat(o,"/").concat(a,".json"),c=await (0,m.e2)(t,i.metadata.title,r.exists),l="".concat(t,"/").concat(c),d="".concat(o,"/").concat(c,".json");await r.exists(n)&&(await r.rename(n,l),await r.rename(s,d))}}async function A(t,e){(null==t?void 0:t.queuedFiles)&&(t.queuedFiles=void 0),(null==t?void 0:t.progress)&&(t.progress=void 0),(null==t?void 0:t.failedFiles)&&(t.failedFiles=void 0),await W.updateExportRecord(e,t)}async function L(t){if(t.exportedCollectionPaths)return Object.fromEntries(Object.entries(t.exportedCollectionPaths).map(t=>{let[e,r]=t;return[e,r.split("/").pop()]}))}async function b(t,e,r){let i;if(!e.length)return;c.ZP.info("updating exported files to exported file paths property, got ".concat(e.length," files"));let o=new Map,s=C(t.exportedCollectionPaths),d=0;for(let t of e){let u;await (0,l.D)(0);let f=s.get(t.collectionID);if(c.ZP.debug(()=>"collection path for ".concat(t.collectionID," is ").concat(f)),t.metadata.fileType===a.Gk.LIVE_PHOTO){let e=await P.Z.getFile(t),r=await new Response(e).blob(),{imageFileName:i,videoFileName:a}=await (0,n.tc)(t.metadata.title,r);u=ta(M(f,i,o),M(f,a,o))}else u=M(f,t.metadata.title,o);c.ZP.debug(()=>"file export name for ".concat(t.metadata.title," is ").concat(u)),i={...i,[J(t)]:u},r({total:e.length,success:d++,failed:0})}return i}async function F(t,e,r){try{let i=await W.getExportRecord(t);(null==i?void 0:i.exportedCollectionPaths)||(i.exportedCollectionPaths={}),i.exportedCollectionPaths={...i.exportedCollectionPaths,[e]:r},await W.updateExportRecord(t,i)}catch(t){throw c.ZP.error("addCollectionExportedRecord failed",t),t}}async function U(t,e){let r=(0,s.M)().fs;if(!(null==e?void 0:e.collectionExportNames))return;let i=Object.entries(e.collectionExportNames),o=[];for(let[e,a]of i)await r.exists(ti("".concat(t,"/").concat(a)))&&o.push([e,a]);let a=o.map(t=>{let[e]=t;return e}),n=Object.entries(e.fileExportNames).filter(t=>{let[e]=t;return a.includes(Y(e).toString())}),c={...e,collectionExportNames:Object.fromEntries(o),fileExportNames:Object.fromEntries(n)};await W.updateExportRecord(t,c)}let C=t=>new Map(Object.entries(null!=t?t:{}).map(t=>[Number(t[0]),String(t[1])])),k=(t,e)=>{if(!(null==e?void 0:e.exportedFiles))return[];let r=new Set(null==e?void 0:e.exportedFiles);return t.filter(t=>!!r.has(J(t)))},H=t=>t.replaceAll("/","_").replaceAll(" ","_"),Z=(t,e)=>"".concat(t,"/").concat(e),M=(t,e,r)=>{var i;let o=(0,m.BZ)(e),a=1;for(;null===(i=r.get(t))||void 0===i?void 0:i.has(Z(t,o));){let t=(0,y.YA)((0,m.BZ)(e));o=t[1]?"".concat(t[0],"(").concat(a,").").concat(t[1]):"".concat(t[0],"(").concat(a,")"),a++}return r.has(t)||r.set(t,new Set),r.get(t).add(Z(t,o)),o},X="export_status.json",G="metadata",j="Trash";(i=o||(o={}))[i.INIT=0]="INIT",i[i.MIGRATION=1]="MIGRATION",i[i.STARTING=2]="STARTING",i[i.EXPORTING_FILES=3]="EXPORTING_FILES",i[i.TRASHING_DELETED_FILES=4]="TRASHING_DELETED_FILES",i[i.RENAMING_COLLECTION_FOLDERS=5]="RENAMING_COLLECTION_FOLDERS",i[i.TRASHING_DELETED_COLLECTIONS=6]="TRASHING_DELETED_COLLECTIONS",i[i.FINISHED=7]="FINISHED";let q={version:3,lastAttemptTimestamp:null,stage:0,fileExportNames:{},collectionExportNames:{}};class B{getExportSettings(){try{if(this.exportSettings)return this.exportSettings;let t=(0,f.Yu)(f.Pd.EXPORT);return this.exportSettings=t,t}catch(t){throw c.ZP.error("getExportSettings failed",t),t}}updateExportSettings(t){try{let e={...this.getExportSettings(),...t};this.exportSettings=e,(0,f.a_)(f.Pd.EXPORT,e)}catch(t){throw c.ZP.error("updateExportSettings failed",t),t}}async runMigration(t,e,r){try{c.ZP.info("running migration"),await R(t,e,r),c.ZP.info("migration completed")}catch(t){throw c.ZP.error("migration failed",t),t}}setUIUpdaters(t){this.uiUpdater=t,this.uiUpdater.setExportProgress(this.currentExportProgress)}updateExportProgress(t){this.currentExportProgress=t,this.uiUpdater.setExportProgress(t)}async updateExportStage(t){var e;let r=null===(e=this.getExportSettings())||void 0===e?void 0:e.folder;await this.updateExportRecord(r,{stage:t}),this.uiUpdater.setExportStage(t)}async updateLastExportTime(t){var e;let r=null===(e=this.getExportSettings())||void 0===e?void 0:e.folder;await this.updateExportRecord(r,{lastAttemptTimestamp:t}),this.uiUpdater.setLastExportTime(t)}enableContinuousExport(){try{if(this.continuousExportEventHandler){c.ZP.info("continuous export already enabled");return}c.ZP.info("enabling continuous export"),this.continuousExportEventHandler=()=>{this.scheduleExport()},this.continuousExportEventHandler(),u.Y.addListener(u.z.LOCAL_FILES_UPDATED,this.continuousExportEventHandler)}catch(t){throw c.ZP.error("failed to enableContinuousExport ",t),t}}disableContinuousExport(){try{if(!this.continuousExportEventHandler){c.ZP.info("continuous export already disabled");return}c.ZP.info("disabling continuous export"),u.Y.removeListener(u.z.LOCAL_FILES_UPDATED,this.continuousExportEventHandler),this.continuousExportEventHandler=null}catch(t){throw c.ZP.error("failed to disableContinuousExport",t),t}}async preExport(t){await this.verifyExportFolderExists(t);let e=await this.getExportRecord(t);await this.updateExportStage(1),await this.runMigration(t,e,this.updateExportProgress.bind(this)),await this.updateExportStage(2)}async postExport(){try{var t;let e=null===(t=this.getExportSettings())||void 0===t?void 0:t.folder;if(!await this.exportFolderExists(e)){this.uiUpdater.setExportStage(0);return}await this.updateExportStage(7),await this.updateLastExportTime(Date.now());let r=await this.getExportRecord(e),i=await this.getPendingExports(r);this.uiUpdater.setPendingExports(i)}catch(t){c.ZP.error("postExport failed",t)}}async stopRunningExport(){try{c.ZP.info("user requested export cancellation"),this.exportInProgress.exec(),this.exportInProgress=null,this.reRunNeeded=!1,await this.postExport()}catch(t){c.ZP.error("stopRunningExport failed",t)}}async runExport(t,e){try{let r=(0,f.Yu)(f.Pd.USER),i=(0,w.SA)(await (0,O.NJ)()),o=await (0,T.Iz)(),a=new Map(o.map(t=>[t.id,t.owner.id])),n=(0,w.$9)(i,r,a),s=(0,p.R5)(o,n,r),l=await this.getExportRecord(t),d=V(l.collectionExportNames),u=(0,p.Ew)(s),h=K(s,l),E=tt(n,l),m=$(n,l),g=Q(s,l);c.ZP.info("personal files:".concat(n.length," unexported files: ").concat(m.length,", deleted exported files: ").concat(E.length,", renamed collections: ").concat(h.length,", deleted collections: ").concat(g.length));let P=0,y=0;this.uiUpdater.setExportProgress({success:P,failed:y,total:m.length}),(null==h?void 0:h.length)>0&&(this.updateExportStage(5),c.ZP.info("renaming ".concat(h.length," collections")),await this.collectionRenamer(t,d,h,e)),(null==E?void 0:E.length)>0&&(this.updateExportStage(4),c.ZP.info("trashing ".concat(E.length," files")),await this.fileTrasher(t,d,E,e)),(null==m?void 0:m.length)>0&&(this.updateExportStage(3),c.ZP.info("exporting ".concat(m.length," files")),await this.fileExporter(m,u,d,t,()=>{this.updateExportProgress({success:++P,failed:y,total:m.length})},()=>{this.updateExportProgress({success:P,failed:++y,total:m.length})},e)),(null==g?void 0:g.length)>0&&(this.updateExportStage(6),c.ZP.info("removing ".concat(g.length," collections")),await this.collectionRemover(g,t,e))}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&t.message!==d.sH.EXPORT_STOPPED&&c.ZP.error("runExport failed",t),t}}async collectionRenamer(t,e,r,i){let o=(0,s.M)().fs;try{for(let a of r)try{if(i.status)throw Error(d.sH.EXPORT_STOPPED);await this.verifyExportFolderExists(t);let r=e.get(a.id),n="".concat(t,"/").concat(r),s=await (0,m.MC)(t,(0,p.wR)(a),o.exists);c.ZP.info("renaming collection with id ".concat(a.id," from ").concat(r," to ").concat(s));let l="".concat(t,"/").concat(s);await this.addCollectionExportedRecord(t,a.id,s),e.set(a.id,s);try{await o.rename(n,l)}catch(i){throw await this.addCollectionExportedRecord(t,a.id,r),e.set(a.id,r),i}c.ZP.info("renaming collection with id ".concat(a.id," from ").concat(r," to ").concat(s," successful"))}catch(t){if(c.ZP.error("collectionRenamer failed a collection",t),t.message===d.sH.UPDATE_EXPORTED_RECORD_FAILED||t.message===d.sH.EXPORT_FOLDER_DOES_NOT_EXIST||t.message===d.sH.EXPORT_STOPPED)throw t}}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&t.message!==d.sH.EXPORT_STOPPED&&c.ZP.error("collectionRenamer failed",t),t}}async collectionRemover(t,e,r){let i=(0,s.M)().fs,o=async t=>{await i.exists(t)&&await i.rmdir(t)};try{let i=await this.getExportRecord(e),a=V(i.collectionExportNames);for(let n of t)try{if(r.status)throw Error(d.sH.EXPORT_STOPPED);await this.verifyExportFolderExists(e),c.ZP.info("removing collection with id ".concat(n," from export folder"));let t=a.get(n);if(te(i,n).length>0)throw Error("collection is not empty, can't remove");let s="".concat(e,"/").concat(t);await this.removeCollectionExportedRecord(e,n);try{await o(ti(s)),await o(s)}catch(r){throw await this.addCollectionExportedRecord(e,n,t),r}c.ZP.info("removing collection with id ".concat(n," from export folder successful"))}catch(t){if(c.ZP.error("collectionRemover failed a collection",t),t.message===d.sH.UPDATE_EXPORTED_RECORD_FAILED||t.message===d.sH.EXPORT_FOLDER_DOES_NOT_EXIST||t.message===d.sH.EXPORT_STOPPED)throw t}}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&t.message!==d.sH.EXPORT_STOPPED&&c.ZP.error("collectionRemover failed",t),t}}async fileExporter(t,e,r,i,o,a,n){let l=(0,s.M)().fs;try{for(let s of t){if(c.ZP.info("exporting file ".concat(s.metadata.title," with id ").concat(s.id," from collection ").concat(e.get(s.collectionID))),n.status)throw Error(d.sH.EXPORT_STOPPED);try{await this.verifyExportFolderExists(i);let t=r.get(s.collectionID);t||(t=await this.createNewCollectionExport(i,s.collectionID,e),await this.addCollectionExportedRecord(i,s.collectionID,t),r.set(s.collectionID,t));let a="".concat(i,"/").concat(t);await l.mkdirIfNeeded(a),await l.mkdirIfNeeded(ti(a)),await this.downloadAndSave(i,a,s),o(),c.ZP.info("exporting file ".concat(s.metadata.title," with id ").concat(s.id," from collection ").concat(e.get(s.collectionID)," successful"))}catch(t){if(a(),c.ZP.error("export failed for a file",t),t.message===d.sH.UPDATE_EXPORTED_RECORD_FAILED||t.message===d.sH.EXPORT_FOLDER_DOES_NOT_EXIST||t.message===d.sH.EXPORT_STOPPED)throw t}}}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&t.message!==d.sH.EXPORT_STOPPED&&c.ZP.error("fileExporter failed",t),t}}async fileTrasher(t,e,r,i){try{let o=await this.getExportRecord(t),a=z(o.fileExportNames);for(let o of r){if(await this.verifyExportFolderExists(t),c.ZP.info("trashing file with id ".concat(o)),i.status)throw Error(d.sH.EXPORT_STOPPED);try{let r=a.get(o),i=Y(o),n=e.get(i);if(tn(r)){let{image:e,video:i}=ts(r);await tc(t,n,e),await tc(t,n,i)}else await tc(t,n,r);await this.removeFileExportedRecord(t,o),c.ZP.info("Moved file id ".concat(o," to Trash"))}catch(t){if(c.ZP.error("trashing failed for a file",t),t.message===d.sH.UPDATE_EXPORTED_RECORD_FAILED||t.message===d.sH.EXPORT_FOLDER_DOES_NOT_EXIST||t.message===d.sH.EXPORT_STOPPED)throw t}}}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&t.message!==d.sH.EXPORT_STOPPED&&c.ZP.error("fileTrasher failed",t),t}}async addFileExportedRecord(t,e,r){try{let i=await this.getExportRecord(t);i.fileExportNames||(i.fileExportNames={}),i.fileExportNames={...i.fileExportNames,[e]:r},await this.updateExportRecord(t,i)}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&c.ZP.error("addFileExportedRecord failed",t),t}}async addCollectionExportedRecord(t,e,r){try{let i=await this.getExportRecord(t);(null==i?void 0:i.collectionExportNames)||(i.collectionExportNames={}),i.collectionExportNames={...i.collectionExportNames,[e]:r},await this.updateExportRecord(t,i)}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&c.ZP.error("addCollectionExportedRecord failed",t),t}}async removeCollectionExportedRecord(t,e){try{let r=await this.getExportRecord(t);r.collectionExportNames=Object.fromEntries(Object.entries(r.collectionExportNames).filter(t=>{let[r]=t;return r!==e.toString()})),await this.updateExportRecord(t,r)}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&c.ZP.error("removeCollectionExportedRecord failed",t),t}}async removeFileExportedRecord(t,e){try{let r=await this.getExportRecord(t);r.fileExportNames=Object.fromEntries(Object.entries(r.fileExportNames).filter(t=>{let[r]=t;return r!==e})),await this.updateExportRecord(t,r)}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&c.ZP.error("removeFileExportedRecord failed",t),t}}async updateExportRecord(t,e){return this.exportRecordUpdater.queueUpRequest(()=>this.updateExportRecordHelper(t,e)).promise}async updateExportRecordHelper(t,e){try{let r={...await this.getExportRecord(t),...e};return await (0,s.M)().fs.writeFile("".concat(t,"/").concat(X),JSON.stringify(r,null,2)),r}catch(t){if(t.message===d.sH.EXPORT_FOLDER_DOES_NOT_EXIST)throw t;throw c.ZP.error("error updating Export Record",t),Error(d.sH.UPDATE_EXPORTED_RECORD_FAILED)}}async getExportRecord(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=(0,s.M)().fs;try{await this.verifyExportFolderExists(t);let e="".concat(t,"/").concat(X);if(!await r.exists(e))return this.createEmptyExportRecord(e);let i=await r.readTextFile(e);try{return JSON.parse(i)}catch(t){throw Error(d.sH.EXPORT_RECORD_JSON_PARSING_FAILED)}}catch(r){if(r.message===d.sH.EXPORT_RECORD_JSON_PARSING_FAILED&&e)return await (0,l.D)(1e3),await this.getExportRecord(t,!1);throw r.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&c.ZP.error("export Record JSON parsing failed",r),r}}async createNewCollectionExport(t,e,r){let i=(0,s.M)().fs;await this.verifyExportFolderExists(t);let o=r.get(e),a=await (0,m.MC)(t,o,i.exists),n="".concat(t,"/").concat(a);return await i.mkdirIfNeeded(n),await i.mkdirIfNeeded(ti(n)),a}async downloadAndSave(t,e,r){let i=(0,s.M)();try{let o=J(r),n=await P.Z.getFile(r);this.fileReader||(this.fileReader=new FileReader);let s=await (0,w.c2)(this.fileReader,r,n);if(r.metadata.fileType===a.Gk.LIVE_PHOTO)await this.exportLivePhoto(t,o,e,s,r);else{let a=await (0,m.e2)(e,r.metadata.title,i.fs.exists);await this.saveMetadataFile(e,a,r),await (0,g.Ps)(i,"".concat(e,"/").concat(a),s),await this.addFileExportedRecord(t,o,a)}}catch(t){throw c.ZP.error("download and save failed",t),t}}async exportLivePhoto(t,e,r,i,o){let a=(0,s.M)().fs,c=await new Response(i).blob(),l=await (0,n.tc)(o.metadata.title,c),d=await (0,m.e2)(r,l.imageFileName,a.exists),u=await (0,m.e2)(r,l.videoFileName,a.exists),f=ta(d,u);await this.saveMetadataFile(r,d,o),await (0,g.Ps)(electron,"".concat(r,"/").concat(d),new Response(l.imageData).body),await this.saveMetadataFile(r,u,o);try{await (0,g.Ps)(electron,"".concat(r,"/").concat(u),new Response(l.videoData).body)}catch(t){throw await a.rm("".concat(r,"/").concat(d)),t}await this.addFileExportedRecord(t,e,f)}async saveMetadataFile(t,e,r){await (0,s.M)().fs.writeFile(to(t,e),tr(e,r))}constructor(){this.exportInProgress=null,this.reRunNeeded=!1,this.exportRecordUpdater=new E.Z,this.fileReader=null,this.uiUpdater={setExportProgress:()=>{},setExportStage:()=>{},setLastExportTime:()=>{},setPendingExports:()=>{}},this.currentExportProgress={total:0,success:0,failed:0},this.getPendingExports=async t=>{try{let e=(0,f.Yu)(f.Pd.USER),r=await (0,O.NJ)(),i=await (0,T.Iz)(),o=new Map(i.map(t=>[t.id,t.owner.id])),a=(0,w.$9)(r,e,o);return $(a,t)}catch(t){throw c.ZP.error("getUpdateFileLists failed",t),t}},this.scheduleExport=async()=>{try{if(this.exportInProgress){c.ZP.info("export in progress, scheduling re-run"),this.reRunNeeded=!0;return}c.ZP.info("export not in progress, starting export");let e={status:!1};this.exportInProgress={exec:()=>{e.status=!0}};try{var t;let r=null===(t=this.getExportSettings())||void 0===t?void 0:t.folder;await this.preExport(r),c.ZP.info("export started"),await this.runExport(r,e),c.ZP.info("export completed")}finally{e.status?(c.ZP.info("export cancellation done"),this.exportInProgress||await this.postExport()):(await this.postExport(),c.ZP.info("resetting export in progress after completion"),this.exportInProgress=null,this.reRunNeeded&&(this.reRunNeeded=!1,c.ZP.info("re-running export"),setTimeout(()=>this.scheduleExport(),0)))}}catch(t){t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&t.message!==d.sH.EXPORT_STOPPED&&c.ZP.error("scheduleExport failed",t)}},this.isExportInProgress=()=>this.exportInProgress,this.exportFolderExists=async t=>t&&await (0,s.M)().fs.exists(t),this.verifyExportFolderExists=async t=>{try{if(!await this.exportFolderExists(t))throw Error(d.sH.EXPORT_FOLDER_DOES_NOT_EXIST)}catch(t){throw t.message!==d.sH.EXPORT_FOLDER_DOES_NOT_EXIST&&c.ZP.error("verifyExportFolderExists failed",t),t}},this.createEmptyExportRecord=async t=>(await (0,s.M)().fs.writeFile(t,JSON.stringify(q,null,2)),q)}}var W=new B;let J=t=>"".concat(t.id,"_").concat(t.collectionID,"_").concat(t.updationTime),Y=t=>Number(t.split("_")[1]),V=t=>new Map(Object.entries(null!=t?t:{}).map(t=>[Number(t[0]),String(t[1])])),z=t=>new Map(Object.entries(null!=t?t:{}).map(t=>[String(t[0]),String(t[1])])),K=(t,e)=>{if(!(null==e?void 0:e.collectionExportNames))return[];let r=V(e.collectionExportNames);return t.filter(t=>{if(r.has(t.id)){let e=r.get(t.id),i=(0,p.wR)(t);return e!==i&&i!==(e.match(/\(\d+\)$/)?e.replace(/\(\d+\)$/,""):e)}return!1})},Q=(t,e)=>{if(!(null==e?void 0:e.collectionExportNames))return[];let r=new Set(t.map(t=>t.id));return Object.keys(null==e?void 0:e.collectionExportNames).map(Number).filter(t=>!r.has(t))},$=(t,e)=>{if(!(null==e?void 0:e.fileExportNames))return t;let r=new Set(Object.keys(null==e?void 0:e.fileExportNames));return t.filter(t=>!r.has(J(t)))},tt=(t,e)=>{if(!(null==e?void 0:e.fileExportNames))return[];let r=new Set(null==t?void 0:t.map(t=>J(t)));return Object.keys(null==e?void 0:e.fileExportNames).filter(t=>!r.has(t))},te=(t,e)=>(null==t?void 0:t.fileExportNames)?Object.keys(null==t?void 0:t.fileExportNames).filter(t=>Number(t.split("_")[1])===e):[],tr=(t,e)=>{var r,i,o;let a=e.metadata,n=Math.floor(a.creationTime/1e6),s=Math.floor((null!==(o=a.modificationTime)&&void 0!==o?o:a.creationTime)/1e6);return JSON.stringify({title:t,caption:null==e?void 0:null===(i=e.pubMagicMetadata)||void 0===i?void 0:null===(r=i.data)||void 0===r?void 0:r.caption,creationTime:{timestamp:n,formatted:(0,h.Uj)(1e3*n)},modificationTime:{timestamp:s,formatted:(0,h.Uj)(1e3*s)},geoData:{latitude:a.latitude,longitude:a.longitude}},null,2)},ti=t=>"".concat(t,"/").concat(G),to=(t,e)=>"".concat(t,"/").concat(G,"/").concat(e,".json"),ta=(t,e)=>JSON.stringify({image:t,video:e}),tn=t=>{try{return JSON.parse(t),!0}catch(t){return!1}},ts=t=>{let{image:e,video:r}=JSON.parse(t);return{image:e,video:r}},tc=async(t,e,r)=>{let i=(0,s.M)().fs,o="".concat(t,"/").concat(e,"/").concat(r),a="".concat(t,"/").concat(j,"/").concat(e),n="".concat(r,".json"),l="".concat(t,"/").concat(e,"/").concat(G,"/").concat(n),d="".concat(t,"/").concat(j,"/").concat(e,"/").concat(G);if(c.ZP.info("Moving file ".concat(o," and its metadata to trash folder")),await i.exists(o)){await i.mkdirIfNeeded(a);let t=await (0,m.e2)(a,r,i.exists),e="".concat(a,"/").concat(t);await i.rename(o,e)}if(await i.exists(l)){await i.mkdirIfNeeded(d);let t=await (0,m.e2)(d,n,i.exists),e="".concat(d,"/").concat(t);await i.rename(l,e)}}},25869:function(t,e,r){"use strict";r.d(e,{An:function(){return c}});var i,o,a=r(10986);r(6114);var n=r(10277);(i=o||(o={})).CREATION_TIME="creation_time",i.APPLE_CONTENT_IDENTIFIER="com.apple.quicktime.content.identifier",i.APPLE_LIVE_PHOTO_IDENTIFIER="com.apple.quicktime.live-photo.auto",i.APPLE_CREATION_DATE="com.apple.quicktime.creationdate",i.APPLE_LOCATION_ISO="com.apple.quicktime.location.ISO6709",i.LOCATION="location";let s=async(t,e,r)=>{let i=await u.lazy();return await i.exec(t,e,r)},c=async t=>{let e=globalThis.electron;return e?l(e,t):s(["FFMPEG","-i","INPUT","-preset","ultrafast","OUTPUT"],t,"mp4")},l=async(t,e)=>{let r=await (0,n.w2)(t,e),i=await (0,n.r8)(t,r);return(0,n.N)(t,r),i};class d{async lazy(){return this.instance||(this.instance=this.createComlinkWorker().remote),this.instance}constructor(){this.createComlinkWorker=()=>new a.d("ffmpeg-worker",new Worker(r.tu(new URL(r.p+r.u(2942),r.b))))}}let u=new d},82797:function(t,e,r){"use strict";r.d(e,{NJ:function(){return a}}),r(96045),r(88659),r(44439),r(73873);var i=r(95525),o=r(89610);r(94522),r(79541),r(5155),(0,i.O3)();let a=async()=>[].concat(await n("normal"),await n("hidden")),n=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"normal";return await o.Z.getItem("normal"===t?"files":"hidden-files")||[]}},77060:function(t,e,r){"use strict";r.d(e,{x:function(){return d}});var i=r(10986);let o=()=>new Worker(r.tu(new URL(r.p+r.u(6167),r.b))),a=()=>new i.d("heic-convert-worker",o());var n=r(96045),s=r(18786),c=r(86345),l=r(7174);let d=t=>h.convert(t),u=[100,100];class f{initIfNeeded(){if(!(this.workerPool.length>0)){this.workerPool=[];for(let t=0;t<2;t++)this.workerPool.push(a())}}async convert(t){this.initIfNeeded();let e=this.convertProcessor.queueUpRequest(()=>(0,c.S0)(async()=>{let e=this.workerPool.shift(),r=await e.remote;try{let i=await new Promise((e,i)=>{(async()=>{try{let o=setTimeout(()=>{i(Error("wait time exceeded"))},3e4),a=Date.now(),s=await r.heicToJPEG(t),c=Date.now()-a;n.ZP.debug(()=>"heic => jpeg (".concat(c," ms)")),clearTimeout(o),e(s)}catch(t){i(t)}})()});return i&&(null==i?void 0:i.size)!==0||n.ZP.error("Converted HEIC file is empty (original was ".concat(null==t?void 0:t.size," bytes)")),await new Promise(t=>{setTimeout(()=>t(null),1e3)}),this.workerPool.push(e),i}catch(t){throw n.ZP.error("HEIC conversion failed",t),e.terminate(),this.workerPool.push(a()),t}},u));try{return await e.promise}catch(t){if(t.message===s.sH.REQUEST_CANCELLED)return null;throw t}}constructor(){this.convertProcessor=new l.Z,this.workerPool=[]}}let h=new f},55071:function(t,e,r){"use strict";r(96045),r(73873);var i=r(95525);r(89610),r(94522),r(79541),r(5155),(0,i.O3)()},59372:function(t,e,r){"use strict";r(96045),r(92660),r(18786),r(73873);var i=r(95525);r(10005),r(94522),r(78806),(0,i.O3)()},76420:function(t,e,r){"use strict";var i,o;(o=i||(i={})).VIEWER="VIEWER",o.OWNER="OWNER",o.COLLABORATOR="COLLABORATOR",o.UNKNOWN="UNKNOWN"},40795:function(t,e,r){"use strict";var i,o,a,n;r.d(e,{Y:function(){return i},_:function(){return o}}),(a=i||(i={}))[a.VISIBLE=0]="VISIBLE",a[a.ARCHIVED=1]="ARCHIVED",a[a.HIDDEN=2]="HIDDEN",(n=o||(o={}))[n.DEFAULT=0]="DEFAULT",n[n.DEFAULT_HIDDEN=1]="DEFAULT_HIDDEN",n[n.QUICK_LINK_COLLECTION=2]="QUICK_LINK_COLLECTION"},16414:function(t,e,r){"use strict";r.d(e,{D0:function(){return f},Ew:function(){return h},R5:function(){return d},bA:function(){return u},wR:function(){return E}}),r(96045),r(18786),r(10005),r(17022);var i,o,a=r(22216);r(24991);var n=r(5155);r(82797),r(76420);var s=r(40795);r(79541),r(71583),r(63490),r(79644).Buffer,(o=i||(i={}))[o.ADD=0]="ADD",o[o.MOVE=1]="MOVE",o[o.REMOVE=2]="REMOVE",o[o.RESTORE=3]="RESTORE",o[o.UNHIDE=4]="UNHIDE";let c=t=>{var e;return(null===(e=t.magicMetadata)||void 0===e?void 0:e.data.subType)===s._.DEFAULT_HIDDEN},l=t=>{var e;return(null===(e=t.magicMetadata)||void 0===e?void 0:e.data.visibility)===s.Y.HIDDEN};function d(t,e,r){if(!(null==r?void 0:r.id))throw Error("user missing");return(0,n.kp)(t,e).filter(t=>t.owner.id===(null==r?void 0:r.id))}function u(t){return t.filter(t=>!l(t))}function f(t){return t.filter(t=>l(t))}function h(t){return new Map((null!=t?t:[]).map(t=>[t.id,E(t)]))}let E=t=>c(t)?a._:t.name},71583:function(t,e,r){"use strict";r(88659),r(40795)},63490:function(t,e,r){"use strict";r.d(e,{BZ:function(){return s},MC:function(){return c},e2:function(){return l}});var i=r(54032),o=r(17826),a=r.n(o),n=r(32522);let s=t=>a()(t,{replacement:"_"}),c=async(t,e,r)=>{let i=[n.Ie,n.ob],o=s(e),a=1;for(;await r("".concat(t,"/").concat(o))||i.includes(o);)o="".concat(s(e),"(").concat(a,")"),a++;return o},l=async(t,e,r)=>{let o=s(e),a=1;for(;await r("".concat(t,"/").concat(o));){let[t,r]=(0,i.YA)(s(e));o=r?"".concat(t,"(").concat(a,").").concat(r):"".concat(t,"(").concat(a,")"),a++}return o}},10277:function(t,e,r){"use strict";r.d(e,{N:function(){return n},Ps:function(){return i},r8:function(){return a},w2:function(){return o}});let i=async(t,e,r)=>{let i=new URLSearchParams({path:e}),o=new URL("stream://write?".concat(i.toString())),a=new Request(o,{method:"POST",body:r,duplex:"half"}),n=await fetch(a);if(!n.ok)throw Error("Failed to write stream to ".concat(o,": HTTP ").concat(n.status))},o=async(t,e)=>{let r="stream://convert-to-mp4",i=new Request(r,{method:"POST",body:e,duplex:"half"}),o=await fetch(i);if(!o.ok)throw Error("Failed to write stream to ".concat(r,": HTTP ").concat(o.status));return o.text()},a=async(t,e)=>{let r=new URLSearchParams({token:e}),i=new URL("stream://convert-to-mp4?".concat(r.toString())),o=new Request(i,{method:"GET"}),a=await fetch(o);if(!a.ok)throw Error("Failed to read stream from ".concat(i,": HTTP ").concat(a.status));return a.blob()},n=async(t,e)=>{let r=new URLSearchParams({token:e,done:"1"}),i=new URL("stream://convert-to-mp4?".concat(r.toString())),o=new Request(i,{method:"GET"}),a=await fetch(o);if(!a.ok)throw Error("Failed to close stream at ".concat(i,": HTTP ").concat(a.status))}},78806:function(t,e,r){"use strict";r(96045),r(10005)},92660:function(t,e,r){"use strict";r(18786),r(73873);var i=r(95525);r(94522),(0,i.O3)()},58178:function(t,e,r){"use strict";var i,o;r.d(e,{Gk:function(){return i},kz:function(){return a},vD:function(){return n}}),(o=i||(i={}))[o.IMAGE=0]="IMAGE",o[o.VIDEO=1]="VIDEO",o[o.LIVE_PHOTO=2]="LIVE_PHOTO",o[o.OTHERS=3]="OTHERS";let a=[{fileType:0,extension:"jpeg",mimeType:"image/jpeg"},{fileType:0,extension:"jpg",mimeType:"image/jpeg"},{fileType:1,extension:"webm",mimeType:"video/webm"},{fileType:1,extension:"mod",mimeType:"video/mpeg"},{fileType:1,extension:"mp4",mimeType:"video/mp4"},{fileType:0,extension:"gif",mimeType:"image/gif"},{fileType:1,extension:"dv",mimeType:"video/x-dv"},{fileType:1,extension:"wmv",mimeType:"video/x-ms-asf"},{fileType:1,extension:"hevc",mimeType:"video/hevc"},{fileType:0,extension:"raf",mimeType:"image/x-fuji-raf"},{fileType:0,extension:"orf",mimeType:"image/x-olympus-orf"},{fileType:0,extension:"crw",mimeType:"image/x-canon-crw"},{fileType:1,extension:"mov",mimeType:"video/quicktime"}],n=["xmp","html","txt"]},38229:function(t,e,r){"use strict";r.d(e,{y:function(){return o}});let i=["heic","rw2","tiff","arw","cr3","cr2","raf","nef","psd","dng","tif"],o=t=>i.includes(t.toLowerCase())},42917:function(t,e,r){"use strict";r.d(e,{tc:function(){return n}});var i=r(54032),o=r(1297),a=r.n(o);r(58178);let n=async(t,e)=>{let r,o,n,s;let[c]=(0,i.YA)(t),l=await a().loadAsync(e,{createFolders:!0});for(let t in l.files){var d,u;if(t.startsWith("image")){let[,e]=(0,i.YA)(t);r=(0,i.xf)([c,e]),n=await (null===(d=l.files[t])||void 0===d?void 0:d.async("uint8array"))}else if(t.startsWith("video")){let[,e]=(0,i.YA)(t);o=(0,i.xf)([c,e]),s=await (null===(u=l.files[t])||void 0===u?void 0:u.async("uint8array"))}}if(!r||!n||!o||!s)throw Error("Decoded live photo ".concat(t," does not have an image"));return{imageFileName:r,imageData:n,videoFileName:o,videoData:s}}},82155:function(t,e,r){"use strict";r.d(e,{M:function(){return i}});let i=()=>{let t=globalThis.electron;if(t)return t;throw Error("Attempting to assert globalThis.electron in a non-electron context")}},77033:function(t,e,r){"use strict";r.d(e,{iO:function(){return a},lE:function(){return i},ly:function(){return o}});let i=!1,o=()=>!0,a=()=>"function"==typeof importScripts},54032:function(t,e,r){"use strict";r.d(e,{YA:function(){return i},qN:function(){return o},xf:function(){return a}});let i=t=>{let e=t.lastIndexOf(".");return -1==e||0==e?[t,void 0]:[t.slice(0,e),t.slice(e+1)]},o=t=>{let[,e]=i(t);return null==e?void 0:e.toLowerCase()},a=t=>t.filter(t=>!!t).join(".")},14871:function(t,e,r){"use strict";r.d(e,{Q2:function(){return o}}),r(96045);let i="logs",o=t=>{let e={logLine:t,timestamp:Date.now()};try{let t=a();t.length>1e3&&t.slice(t.length-1e3),t.push(e),localStorage.setItem(i,JSON.stringify({logs:t}))}catch(t){console.error("Failed to persist log",t),t instanceof Error&&"QuotaExceededError"===t.name&&localStorage.removeItem(i)}},a=()=>{let t=localStorage.getItem("logs");if(!t)return[];let e=JSON.parse(t);return e&&"object"==typeof e&&"logs"in e&&Array.isArray(e.logs)?e.logs:(console.error("Unexpected log entries obtained from local storage",e),[])}},96045:function(t,e,r){"use strict";r.d(e,{Q2:function(){return n}});var i=r(77033),o=r(14871),a=r(30290);let n=t=>{let e=globalThis.electron;e?e.logToDisk(t):(0,i.iO)()?s(t):(0,o.Q2)(t)},s=t=>{a.j.logToDisk(t).catch(e=>{console.error("Failed to log a message from worker",e,"\nThe message was",t)})},c=(t,e)=>{let r;return e?(r=e instanceof Error?["".concat(e.name,": ").concat(e.message),e.stack].filter(t=>t).join("\n"):String(e),"".concat(t,": ").concat(r)):t};e.ZP={error:(t,e)=>{let r="[error] ".concat(c(t,e));console.error(r),n(r)},warn:(t,e)=>{let r="[warn] ".concat(c(t,e));console.error(r),n(r)},info:function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];let o=e.map(t=>"string"==typeof t?t:JSON.stringify(t)).join(" "),a="[info] ".concat(o);i.lE&&console.log(a),n(a)},debug:t=>{i.lE&&console.log("[debug]",t())}}},5083:function(t,e,r){"use strict";r.d(e,{S:function(){return i}});let i={NotAvailable:"This feature in not available on the current OS/arch"}},10986:function(t,e,r){"use strict";r.d(e,{d:function(){return s}});var i=r(82155),o=r(96045),a=r(90758),n=r(92396);class s{terminate(){this.worker.terminate(),o.ZP.debug(()=>"Terminated ".concat(this.name))}constructor(t,e){this.name=t,this.worker=e,e.onerror=e=>{o.ZP.error("Got error event from worker: ".concat(JSON.stringify({event:e,name:t})))},o.ZP.debug(()=>"Initiated web worker ".concat(t));let r=(0,a.Ud)(e);this.remote=new r,(0,a.Jj)(c,e)}}let c={logToDisk:o.Q2,getAuthToken:()=>(0,n.F)().token,convertToJPEG:t=>(0,i.M)().convertToJPEG(t),detectFaces:t=>(0,i.M)().detectFaces(t),computeFaceEmbeddings:t=>(0,i.M)().computeFaceEmbeddings(t)}},88659:function(t,e,r){"use strict";var i=r(10986);class o{async getInstance(){if(!this.comlinkWorkerInstance){let t=a();this.comlinkWorkerInstance=t.remote}return this.comlinkWorkerInstance}}let a=()=>new i.d("ente-crypto-worker",new Worker(r.tu(new URL(r.p+r.u(7644),r.b))));e.Z=new o},44439:function(t,e,r){"use strict";r.d(e,{Y:function(){return n},z:function(){return o}});var i,o,a=r(10161);(i=o||(o={})).LOGOUT="logout",i.FILE_UPLOADED="fileUploaded",i.LOCAL_FILES_UPDATED="localFilesUpdated";let n=new a.EventEmitter},73873:function(t,e,r){"use strict";var i=r(96045),o=r(90162),a=r(18786);class n{setHeaders(t){this.headers={...this.headers,...t}}appendHeader(t,e){this.headers={...this.headers,[t]:e}}removeHeader(t){this.headers[t]=void 0}getInterceptors(){return o.default.interceptors}async request(t,e){return t.headers={...this.headers,...t.headers},(null==e?void 0:e.cancel)&&(t.cancelToken=new o.default.CancelToken(t=>e.cancel.exec=t)),await (0,o.default)({...t,...e})}get(t,e,r,i){return this.request({headers:r,method:"GET",params:e,url:t},i)}post(t,e,r,i,o){return this.request({data:e,headers:i,method:"POST",params:r,url:t},o)}patch(t,e,r,i,o){return this.request({data:e,headers:i,method:"PATCH",params:r,url:t},o)}put(t,e,r,i,o){return this.request({data:e,headers:i,method:"PUT",params:r,url:t},o)}delete(t,e,r,i,o){return this.request({data:e,headers:i,method:"DELETE",params:r,url:t},o)}constructor(){this.headers={"content-type":"application/json"},o.default.interceptors.response.use(t=>Promise.resolve(t),t=>{let e=t.config;if(t.response){let r;let o=t.response;if((0,a.Rp)(o.data)){let n=o.data;i.ZP.error("HTTP Service Error - ".concat(JSON.stringify({url:null==e?void 0:e.url,method:null==e?void 0:e.method,xRequestId:o.headers["x-request-id"],httpStatus:o.status,errMessage:n.message,errCode:n.code})),t),r=new a.MS(n.message,n.code,o.status)}else r=o.status>=400&&o.status<500?new a.MS(a.sH.CLIENT_ERROR,"",o.status):new a.MS(a.sH.ServerError,"",o.status);throw i.ZP.error("HTTP Service Error - ".concat(JSON.stringify({url:e.url,method:e.method,cfRay:o.headers["cf-ray"],xRequestId:o.headers["x-request-id"],httpStatus:o.status})),r),r}return t.request?i.ZP.info("request failed - no response (".concat(e.method," ").concat(e.url)):i.ZP.info("request failed - axios error (".concat(e.method," ").concat(e.url)),Promise.reject(t)})}}e.Z=new n},95525:function(t,e,r){"use strict";r.d(e,{O3:function(){return o},dd:function(){return i}}),r(93542);let i=()=>"http://pi.sanyaas.org:8080",o=()=>"http://pi.sanyaas.org:8080"},89610:function(t,e,r){"use strict";var i=r(77033),o=r(75486),a=r.n(o);(0,i.ly)()&&a().config({name:"ente-files",version:1,storeName:"files"}),e.Z=a()},10005:function(t,e,r){"use strict";r.d(e,{Pd:function(){return o},Yu:function(){return s},a_:function(){return n}});var i,o,a=r(96045);(i=o||(o={})).USER="user",i.SESSION="session",i.KEY_ATTRIBUTES="keyAttributes",i.ORIGINAL_KEY_ATTRIBUTES="originalKeyAttributes",i.SUBSCRIPTION="subscription",i.FAMILY_DATA="familyData",i.IS_FIRST_LOGIN="isFirstLogin",i.JUST_SIGNED_UP="justSignedUp",i.SHOW_BACK_BUTTON="showBackButton",i.EXPORT="export",i.THUMBNAIL_FIX_STATE="thumbnailFixState",i.LIVE_PHOTO_INFO_SHOWN_COUNT="livePhotoInfoShownCount",i.USER_DETAILS="userDetails",i.COLLECTION_SORT_BY="collectionSortBy",i.THEME="theme",i.WAIT_TIME="waitTime",i.API_ENDPOINT="apiEndpoint",i.MAP_ENABLED="mapEnabled",i.SRP_SETUP_ATTRIBUTES="srpSetupAttributes",i.SRP_ATTRIBUTES="srpAttributes",i.CF_PROXY_DISABLED="cfProxyDisabled",i.REFERRAL_SOURCE="referralSource",i.CLIENT_PACKAGE="clientPackage";let n=(t,e)=>localStorage.setItem(t,JSON.stringify(e)),s=t=>{try{if("undefined"==typeof localStorage||void 0===t||void 0===localStorage.getItem(t)||"undefined"===localStorage.getItem(t))return null;let e=localStorage.getItem(t);return e&&JSON.parse(e)}catch(e){a.ZP.error("Failed to Parse JSON for key ".concat(t),e)}}},24450:function(t,e,r){"use strict";var i,o;(o=i||(i={})).ENCRYPTION_KEY="encryptionKey",o.KEY_ENCRYPTION_KEY="keyEncryptionKey"},62594:function(t,e,r){"use strict";r.d(e,{Uj:function(){return a}});var i=r(24991);new Intl.DateTimeFormat(i.ZP.language,{weekday:"short",month:"short",day:"numeric"}),new Intl.DateTimeFormat(i.ZP.language,{year:"numeric"});let o=new Intl.DateTimeFormat(i.ZP.language,{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"});function a(t){return o.format(t)}new Intl.DateTimeFormat(i.ZP.language,{timeStyle:"short"})},35042:function(t,e,r){"use strict";r(88659),r(18786),r(24450)},86345:function(t,e,r){"use strict";r.d(e,{S0:function(){return o}});var i=r(11200);async function o(t,e){e||(e=[2e3,5e3,1e4]);for(let r=0;r<=e.length;r++)try{return await t()}catch(t){if(r===e.length)throw t;await (0,i.D)(e[r])}}},7174:function(t,e,r){"use strict";r.d(e,{Z:function(){return o}});var i=r(18786);class o{queueUpRequest(t){let e={status:!1},r={exec:()=>{e.status=!0}};return{promise:new Promise((i,o)=>{this.requestQueue.push({request:t,successCallback:i,failureCallback:o,isCanceled:e,canceller:r}),this.processQueueIfNeeded()}),canceller:r}}async processQueueIfNeeded(){if(!this.isProcessingRequest){for(this.isProcessingRequest=!0;this.requestQueue.length>0;){let t=this.requestQueue.shift(),e=null;if(t.isCanceled.status)t.failureCallback(Error(i.sH.REQUEST_CANCELLED));else try{e=await t.request(t.canceller),t.successCallback(e)}catch(e){t.failureCallback(e)}}this.isProcessingRequest=!1}}constructor(){this.requestQueue=[],this.isProcessingRequest=!1}}},11200:function(t,e,r){"use strict";r.d(e,{D:function(){return i}});let i=t=>new Promise(e=>setTimeout(e,t))},16777:function(){}}]);